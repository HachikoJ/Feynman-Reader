# 最终评分机制

## 评分逻辑

### 核心公式
```
最终总分 = (教学模拟最高分 + 角色问答最高平均分) / 2
```

### 完成条件（所有条件必须同时满足）

1. **教学模拟最高分 ≥ 60**
   - 从所有教学模拟记录中取最高分
   - 必须达到60分以上

2. **角色问答每次平均分都 ≥ 60**
   - 每次问答记录的3个问题的平均分
   - 所有记录的平均分都必须 ≥ 60
   - 不是单个问题60分，而是每次的平均分

3. **角色问答最高平均分 ≥ 60**
   - 从所有问答记录中找出最高的平均分
   - 必须达到60分以上

4. **最终总分 ≥ 60**
   - (教学最高分 + 问答最高平均分) / 2
   - 必须达到60分以上

## 计算示例

### 示例1：全部通过
```
教学模拟记录：
- 第1次：75分
- 第2次：82分 ← 最高分
- 第3次：70分

角色问答记录：
- 第1次：(65 + 70 + 68) / 3 = 67.67分 ← 平均分
- 第2次：(72 + 75 + 70) / 3 = 72.33分 ← 最高平均分
- 第3次：(68 + 65 + 70) / 3 = 67.67分

检查：
✓ 教学最高分：82 ≥ 60
✓ 问答每次平均分：67.67, 72.33, 67.67 都 ≥ 60
✓ 问答最高平均分：72.33 ≥ 60
✓ 最终总分：(82 + 72.33) / 2 = 77.17 ≥ 60

结果：✅ 全部通过，书籍归档为"已读"
```

### 示例2：教学不合格
```
教学模拟记录：
- 第1次：55分 ← 最高分（不合格）

角色问答记录：
- 第1次：(70 + 72 + 68) / 3 = 70分

检查：
✗ 教学最高分：55 < 60
✓ 问答每次平均分：70 ≥ 60
✓ 问答最高平均分：70 ≥ 60
✓ 最终总分：(55 + 70) / 2 = 62.5 ≥ 60

结果：❌ 教学模拟不合格，无法完成阅读
```

### 示例3：某次问答不合格
```
教学模拟记录：
- 第1次：75分 ← 最高分

角色问答记录：
- 第1次：(55 + 60 + 58) / 3 = 57.67分 ← 不合格
- 第2次：(70 + 72 + 68) / 3 = 70分 ← 最高平均分

检查：
✓ 教学最高分：75 ≥ 60
✗ 问答每次平均分：第1次 57.67 < 60
✓ 问答最高平均分：70 ≥ 60
✓ 最终总分：(75 + 70) / 2 = 72.5 ≥ 60

结果：❌ 第1次问答平均分不合格，无法完成阅读
```

### 示例4：最终总分不合格
```
教学模拟记录：
- 第1次：60分 ← 最高分（刚好合格）

角色问答记录：
- 第1次：(60 + 60 + 60) / 3 = 60分 ← 最高平均分（刚好合格）

检查：
✓ 教学最高分：60 ≥ 60
✓ 问答每次平均分：60 ≥ 60
✓ 问答最高平均分：60 ≥ 60
✓ 最终总分：(60 + 60) / 2 = 60 ≥ 60

结果：✅ 刚好全部通过（边界情况）
```

### 示例5：最终总分不合格
```
教学模拟记录：
- 第1次：62分 ← 最高分

角色问答记录：
- 第1次：(58 + 60 + 60) / 3 = 59.33分 ← 不合格
- 第2次：(60 + 60 + 60) / 3 = 60分 ← 最高平均分

检查：
✓ 教学最高分：62 ≥ 60
✗ 问答每次平均分：第1次 59.33 < 60
✓ 问答最高平均分：60 ≥ 60
✓ 最终总分：(62 + 60) / 2 = 61 ≥ 60

结果：❌ 第1次问答平均分不合格
```

## 技术实现

### 1. checkFeynmanComplete() 函数
```typescript
export function checkFeynmanComplete(bookId: string): boolean {
  // 1. 教学最高分
  const teachingMaxScore = Math.max(...practiceRecords.map(r => r.scores.overall))
  const teachingPassed = teachingMaxScore >= 60
  
  // 2. 问答每次平均分和最高平均分
  let qaMaxAvgScore = 0
  let allQARecordsPassed = true
  
  qaPracticeRecords.forEach(record => {
    const avgScore = average(record.questions.map(q => q.score))
    qaMaxAvgScore = Math.max(qaMaxAvgScore, avgScore)
    if (avgScore < 60) allQARecordsPassed = false
  })
  
  const qaPassed = qaMaxAvgScore >= 60 && allQARecordsPassed
  
  // 3. 最终总分
  const finalScore = (teachingMaxScore + qaMaxAvgScore) / 2
  const finalPassed = finalScore >= 60
  
  // 4. 所有条件都要满足
  return teachingPassed && qaPassed && finalPassed
}
```

### 2. calculateFinalScore() 函数
```typescript
export function calculateFinalScore(bookId: string): number {
  // 教学最高分
  const teachingMaxScore = Math.max(...practiceRecords.map(r => r.scores.overall))
  
  // 问答最高平均分
  let qaMaxAvgScore = 0
  qaPracticeRecords.forEach(record => {
    const avgScore = average(record.questions.map(q => q.score))
    qaMaxAvgScore = Math.max(qaMaxAvgScore, avgScore)
  })
  
  // 最终总分
  return Math.round((teachingMaxScore + qaMaxAvgScore) / 2)
}
```

### 3. 自动更新
所有相关操作都会自动更新最终总分：
- `addPracticeRecord()` - 添加教学记录
- `deletePracticeRecord()` - 删除教学记录
- `addQAPracticeRecord()` - 添加问答记录
- `updateQAPracticeRecord()` - 更新问答记录
- `deleteQAPracticeRecord()` - 删除问答记录

## 设计理念

### 1. 客观公正
- 综合考虑教学和问答两个维度
- 取最高分，鼓励用户不断尝试
- 平均分机制避免偶然性

### 2. 严格要求
- 所有条件必须同时满足
- 每次问答的平均分都要合格
- 不能有任何一次拖后腿

### 3. 鼓励进步
- 可以多次尝试
- 只看最高分
- 给用户改进的机会

### 4. 防止投机
- 不能只做一次就通过
- 每次问答都要认真对待
- 最终总分也要合格

## 用户体验

### 进度可视化
```
教学模拟：82分 ✓
角色问答：
  - 第1次：67.67分 ✓
  - 第2次：72.33分 ✓（最高）
  - 第3次：67.67分 ✓
最终总分：77分 ✓

状态：✅ 已完成阅读
```

### 未完成提示
```
教学模拟：55分 ✗（需要 ≥ 60）
角色问答：70分 ✓
最终总分：62.5分 ✓

状态：❌ 教学模拟未达标
提示：请重新提交教学模拟，争取达到60分以上
```

## 总结

这套评分机制：

✅ **客观公正** - 综合两个维度，取最高分
✅ **严格要求** - 所有条件都要满足
✅ **鼓励进步** - 可以多次尝试
✅ **防止投机** - 每次都要认真对待
✅ **自动计算** - 实时更新，无需手动

通过这套机制，确保用户真正理解了书籍内容，而不是侥幸通过！
